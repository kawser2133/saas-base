<div class="locations-page" (click)="onMainPageClick($event)">
  <!-- Header -->
  <header class="page-header">
    <div class="header-surface section-header-surface">
      <div class="header-main">
        <div class="title-block">
          <div class="title-content">
            <h1 class="page-title">Location Management</h1>
            <p class="page-description">Manage organization locations and branches</p>
          </div>
        </div>

        <div class="header-actions">
          <div class="header-stats">
            <div class="stat-card">
              <div class="stat-icon">
                <i class="fas fa-map-marker-alt"></i>
              </div>
              <div class="stat-content">
                <span class="stat-value">{{ statistics.total }}</span>
                <span class="stat-label">Total</span>
              </div>
            </div>
          </div>
          <button class="btn btn-primary" type="button" (click)="openAddDialog()">
            <i class="fas fa-plus"></i>
            <span>Add New Location</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Search and Filter Bar -->
  <div class="search-filter-section" (click)="onMainPageClick($event)">
    <div class="search-filter-content">
      <div class="search-section">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" [(ngModel)]="searchQuery" (input)="onSearch()" (focus)="onFormFieldFocus()"
            placeholder="Search by name, address, city, or country..." class="search-input">
          <span class="search-count" *ngIf="searchQuery">{{ totalItems }} results</span>
        </div>
      </div>

      <div class="filter-actions">
        <button class="btn btn-outline" type="button" (click)="refreshData()" [disabled]="isLoading"
          title="Refresh data">
          <i class="fas" [class.fa-sync-alt]="!isLoading" [class.fa-spinner]="isLoading"
            [class.fa-spin]="isLoading"></i>
        </button>

        <button class="btn btn-filter" [class.btn-filter-active]="showFilters" (click)="showFilters = !showFilters" title="Filters">
          <i class="fas fa-filter"></i>
          <span class="filter-badge" *ngIf="activeFilterCount > 0">{{ activeFilterCount }}</span>
        </button>

        <button class="btn btn-outline" type="button" (click)="openImportDialog()" title="Import">
          <i class="fas fa-file-import"></i>
        </button>

        <div class="dropdown">
          <button class="btn btn-outline dropdown-toggle" type="button" (click)="toggleExportDropdown()" title="Export">
            <i class="fas fa-download"></i>
            <span class="filter-badge" *ngIf="selectedItems.size > 0" >{{ selectedItems.size }}</span>
          </button>
          <div class="dropdown-menu" *ngIf="exportDropdownOpen">
            <a class="dropdown-item" (click)="exportLocations('excel'); exportDropdownOpen = false">
              <i class="fas fa-file-excel text-success"></i> Export as Excel
            </a>
            <a class="dropdown-item" (click)="exportLocations('csv'); exportDropdownOpen = false">
              <i class="fas fa-file-csv text-info"></i> Export as CSV
            </a>
            <a class="dropdown-item" (click)="exportLocations('pdf'); exportDropdownOpen = false">
              <i class="fas fa-file-pdf text-danger"></i> Export as PDF
            </a>
            <a class="dropdown-item" (click)="exportLocations('json'); exportDropdownOpen = false">
              <i class="fas fa-file-code text-primary"></i> Export as JSON
            </a>
          </div>
        </div>

        <button class="btn btn-outline" type="button" (click)="openImportHistoryDialog()" title="History">
          <i class="fas fa-history"></i>
        </button>

        <button *ngIf="selectedItems.size > 0" class="btn btn-outline" (click)="cloneSelected()" title="Clone">
          <i class="fas fa-copy"></i>
          <span class="filter-badge">{{ selectedItems.size }}</span>
        </button>
        <button *ngIf="selectedItems.size > 0" class="btn btn-outline" (click)="openDeleteDialog(getSelectedItems())" title="Delete">
          <i class="fas fa-trash"></i>
          <span class="filter-badge">{{ selectedItems.size }}</span>
        </button>
      </div>
    </div>

    <!-- Filter Panel -->
    <div class="filter-panel" *ngIf="showFilters">
      <div class="filter-panel-header">
        <div class="filter-title-section">
          <i class="fas fa-sliders-h"></i>
          <h3>Advanced Filters</h3>
          <span class="filter-count" *ngIf="activeFilterCount > 0">{{ activeFilterCount }} active</span>
        </div>
        <button class="btn btn-sm btn-clear" (click)="clearFilters()" *ngIf="activeFilterCount > 0">
          <i class="fas fa-undo"></i>
          <span>Reset Filters</span>
        </button>
      </div>

      <div class="filter-grid">
        <div class="filter-group">
          <label>Status</label>
          <div class="searchable-dropdown">
            <div class="dropdown-trigger" (click)="toggleSearchableDropdown('filter-status'); $event.stopPropagation()">
              <span class="dropdown-value">
                {{ isActiveFilter === true ? 'Active' : isActiveFilter === false ? 'Inactive' : 'All Statuses' }}
              </span>
              <i 
                *ngIf="hasDropdownValue('filter-status')"
                class="fas fa-times clear-icon"
                (click)="clearDropdownValue('filter-status', $event)"
                title="Clear selection"
              ></i>
              <i class="dropdown-icon"></i>
            </div>
            <div class="dropdown-menu" *ngIf="dropdownStates['filter-status']?.isOpen">
              <div class="dropdown-options">
                <div class="dropdown-option" [class.selected]="isActiveFilter === null"
                  (click)="selectFilterOption('status', null)">
                  All Statuses
                  <i *ngIf="isActiveFilter === null" class="fas fa-check selected-icon"></i>
                </div>
                <div class="dropdown-option" [class.selected]="isActiveFilter === true"
                  (click)="selectFilterOption('status', true)">
                  Active
                  <i *ngIf="isActiveFilter === true" class="fas fa-check selected-icon"></i>
                </div>
                <div class="dropdown-option" [class.selected]="isActiveFilter === false"
                  (click)="selectFilterOption('status', false)">
                  Inactive
                  <i *ngIf="isActiveFilter === false" class="fas fa-check selected-icon"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="filter-group">
          <label>Country</label>
          <div class="searchable-dropdown">
            <div class="dropdown-trigger" (click)="toggleSearchableDropdown('filter-country'); $event.stopPropagation()">
              <span class="dropdown-value">{{ getFilterDisplayValue('country') || 'All Countries' }}</span>
              <i 
                *ngIf="hasDropdownValue('filter-country')"
                class="fas fa-times clear-icon"
                (click)="clearDropdownValue('filter-country', $event)"
                title="Clear selection"
              ></i>
              <i class="dropdown-icon"></i>
            </div>
            <div class="dropdown-menu" *ngIf="dropdownStates['filter-country']?.isOpen">
              <div class="search-input-container">
                <input type="text" class="search-input" placeholder="Search countries..."
                  [value]="dropdownStates['filter-country'].searchTerm" (input)="onSearchInput('filter-country', $event)">
                <i class="search-icon"></i>
              </div>
              <div class="dropdown-options">
                <div class="dropdown-option" [class.selected]="!filters.country" (click)="selectFilterOption('country', '')">
                  All Countries
                  <i *ngIf="!filters.country" class="fas fa-check selected-icon"></i>
                </div>
                <div *ngFor="let option of dropdownStates['filter-country']?.filteredOptions"
                  class="dropdown-option" [class.selected]="filters.country === option"
                  (click)="selectFilterOption('country', option)">
                  {{ option }}
                  <i *ngIf="filters.country === option" class="fas fa-check selected-icon"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="filter-group">
          <label>City</label>
          <div class="searchable-dropdown">
            <div class="dropdown-trigger" (click)="toggleSearchableDropdown('filter-city'); $event.stopPropagation()">
              <span class="dropdown-value">{{ getFilterDisplayValue('city') || 'All Cities' }}</span>
              <i 
                *ngIf="hasDropdownValue('filter-city')"
                class="fas fa-times clear-icon"
                (click)="clearDropdownValue('filter-city', $event)"
                title="Clear selection"
              ></i>
              <i class="dropdown-icon"></i>
            </div>
            <div class="dropdown-menu" *ngIf="dropdownStates['filter-city']?.isOpen">
              <div class="search-input-container">
                <input type="text" class="search-input" placeholder="Search cities..."
                  [value]="dropdownStates['filter-city'].searchTerm" (input)="onSearchInput('filter-city', $event)">
                <i class="search-icon"></i>
              </div>
              <div class="dropdown-options">
                <div class="dropdown-option" [class.selected]="!filters.city" (click)="selectFilterOption('city', '')">
                  All Cities
                  <i *ngIf="!filters.city" class="fas fa-check selected-icon"></i>
                </div>
                <div *ngFor="let option of dropdownStates['filter-city']?.filteredOptions"
                  class="dropdown-option" [class.selected]="filters.city === option"
                  (click)="selectFilterOption('city', option)">
                  {{ option }}
                  <i *ngIf="filters.city === option" class="fas fa-check selected-icon"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="filter-group">
          <label>Created From</label>
          <input type="date" [(ngModel)]="filterFormData.createdFrom" (change)="filters.createdFrom = filterFormData.createdFrom; onFilterChange()"
            class="form-control">
        </div>

        <div class="filter-group">
          <label>Created To</label>
          <input type="date" [(ngModel)]="filterFormData.createdTo" (change)="filters.createdTo = filterFormData.createdTo; onFilterChange()"
            class="form-control">
        </div>
      </div>
    </div>
  </div>

  <!-- Data Display -->
  <div class="data-display" (click)="onMainPageClick($event)">
    <!-- Desktop Table View -->
    <div class="table-container" *ngIf="!isMobile && !isLoading">
      <div class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th class="checkbox-column">
                <input type="checkbox" [checked]="isAllSelected()" (change)="masterToggle()" class="form-check-input">
              </th>
              <th class="sortable" (click)="sortData('name')">
                Name
                <i class="fas fa-sort" *ngIf="sortField !== 'name'"></i>
                <i class="fas fa-sort-up" *ngIf="sortField === 'name' && sortDirection === 'asc'"></i>
                <i class="fas fa-sort-down" *ngIf="sortField === 'name' && sortDirection === 'desc'"></i>
              </th>
              <th class="sortable" (click)="sortData('address')">
                Address
                <i class="fas fa-sort" *ngIf="sortField !== 'address'"></i>
                <i class="fas fa-sort-up" *ngIf="sortField === 'address' && sortDirection === 'asc'"></i>
                <i class="fas fa-sort-down" *ngIf="sortField === 'address' && sortDirection === 'desc'"></i>
              </th>
              <th class="sortable" (click)="sortData('city')">
                City
                <i class="fas fa-sort" *ngIf="sortField !== 'city'"></i>
                <i class="fas fa-sort-up" *ngIf="sortField === 'city' && sortDirection === 'asc'"></i>
                <i class="fas fa-sort-down" *ngIf="sortField === 'city' && sortDirection === 'desc'"></i>
              </th>
              <th class="sortable" (click)="sortData('country')">
                Country
                <i class="fas fa-sort" *ngIf="sortField !== 'country'"></i>
                <i class="fas fa-sort-up" *ngIf="sortField === 'country' && sortDirection === 'asc'"></i>
                <i class="fas fa-sort-down" *ngIf="sortField === 'country' && sortDirection === 'desc'"></i>
              </th>
              <th class="sortable" (click)="sortData('isActive')">
                Status
                <i class="fas fa-sort" *ngIf="sortField !== 'isActive'"></i>
                <i class="fas fa-sort-up" *ngIf="sortField === 'isActive' && sortDirection === 'asc'"></i>
                <i class="fas fa-sort-down" *ngIf="sortField === 'isActive' && sortDirection === 'desc'"></i>
              </th>
              <th class="sortable" (click)="sortData('isDefault')">
                Default
                <i class="fas fa-sort" *ngIf="sortField !== 'isDefault'"></i>
                <i class="fas fa-sort-up" *ngIf="sortField === 'isDefault' && sortDirection === 'asc'"></i>
                <i class="fas fa-sort-down" *ngIf="sortField === 'isDefault' && sortDirection === 'desc'"></i>
              </th>
              <th class="actions-column">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="isLoading" class="loading-row">
              <td colspan="8" class="loading-cell">
                <div class="loading-spinner">
                  <i class="fas fa-spinner fa-spin"></i>
                  <span>Loading locations...</span>
                </div>
              </td>
            </tr>
            <tr *ngIf="!isLoading && paginatedData.length === 0" class="empty-row">
              <td colspan="8" class="empty-cell">
                <div class="empty-state">
                  <i class="fas fa-map-marker-alt"></i>
                  <h3>No locations found</h3>
                  <p>Create your first location to get started</p>
                </div>
              </td>
            </tr>
            <tr *ngFor="let item of paginatedData" class="data-row" [hidden]="isLoading">
              <td class="checkbox-column">
                <input type="checkbox" [checked]="selectedItems.has(item.id)" (change)="toggleItemSelection(item.id)"
                  class="form-check-input">
              </td>
              <td class="item-name">
                <div class="item-name">
                  {{ item.name }}
                </div>
              </td>
              <td>
                <div class="cell-content">
                  {{ item.address || '-' }}
                </div>
              </td>
              <td>
                <div class="cell-content">
                  {{ item.city || '-' }}
                </div>
              </td>
              <td>
                <div class="cell-content">
                  {{ item.country || '-' }}
                </div>
              </td>
              <td class="status">
                <div class="status-container">
                  <div class="status-indicator" [class]="getStatusClass(item.isActive)">
                    <i class="fas" [class]="getStatusIcon(item.isActive)"></i>
                  </div>
                  <span class="status-text" [class]="getStatusClass(item.isActive)">
                    {{ item.isActive ? 'Active' : 'Inactive' }}
                  </span>
                </div>
              </td>
              <td>
                <span class="status-badge" [class.status-active]="item.isDefault" [class.status-inactive]="!item.isDefault">
                  <i class="fas" [class.fa-check-circle]="item.isDefault" [class.fa-times-circle]="!item.isDefault"></i>
                  {{ item.isDefault ? 'Yes' : 'No' }}
                </span>
              </td>
              <td class="actions">
                <div class="action-buttons">
                  <button class="action-btn action-btn-view" (click)="openViewDialog(item)" title="View">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button class="action-btn action-btn-edit" (click)="openEditDialog(item)" title="Edit">
                    <i class="fas fa-edit"></i>
                  </button>
                  <div class="action-dropdown" [class.active]="isDropdownOpen(item)">
                    <button class="action-btn action-btn-more dropdown-toggle" (click)="toggleDropdown(item, $event)" title="More Actions">
                      <i class="fas fa-ellipsis-h"></i>
                    </button>
                    <div class="dropdown-menu" *ngIf="isDropdownOpen(item)" (click)="$event.stopPropagation()">
                      <button class="dropdown-item toggle-action" (click)="toggleActiveStatusAndClose(item)">
                        <i class="fas" [class.fa-toggle-on]="!item.isActive" [class.fa-toggle-off]="item.isActive"></i>
                        <span>{{ item.isActive ? 'Deactivate' : 'Activate' }}</span>
                      </button>
                      <button class="dropdown-item" (click)="cloneLocation(item); closeDropdown(item)">
                        <i class="fas fa-copy"></i>
                        <span>Clone</span>
                      </button>
                      <button class="dropdown-item delete" (click)="deleteItemAndClose(item)">
                        <i class="fas fa-trash-alt"></i>
                        <span>Delete</span>
                      </button>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Mobile Card View -->
    <div class="mobile-cards" *ngIf="isMobile">
      <div *ngIf="isLoading" class="loading-spinner">
        <i class="fas fa-spinner fa-spin"></i>
        <span>Loading locations...</span>
      </div>

      <div *ngIf="!isLoading && paginatedData.length === 0" class="empty-state">
        <i class="fas fa-map-marker-alt"></i>
        <h3>No locations found</h3>
        <p>Create your first location to get started</p>
      </div>

      <div *ngFor="let item of paginatedData" class="mobile-card" [hidden]="isLoading">
        <div class="mobile-card-header">
          <div class="mobile-card-checkbox">
            <input type="checkbox" [checked]="selectedItems.has(item.id)" (change)="toggleItemSelection(item.id)"
              class="form-check-input">
          </div>
          <div class="mobile-card-title">
            <div class="location-details">
              <div class="location-name">{{ item.name }}</div>
              <div class="location-address" *ngIf="item.address">{{ item.address }}</div>
            </div>
          </div>
          <div class="mobile-card-status">
            <div class="status-container">
              <div class="status-indicator" [class]="getStatusClass(item.isActive)">
                <i class="fas" [class]="getStatusIcon(item.isActive)"></i>
              </div>
              <span class="status-text" [class]="getStatusClass(item.isActive)">
                {{ item.isActive ? 'Active' : 'Inactive' }}
              </span>
            </div>
          </div>
        </div>

        <div class="mobile-card-body">
          <div class="mobile-card-grid">
            <div class="mobile-card-field">
              <span class="field-label">City:</span>
              <span class="field-value">{{ item.city || '-' }}</span>
            </div>
            <div class="mobile-card-field">
              <span class="field-label">Country:</span>
              <span class="field-value">{{ item.country || '-' }}</span>
            </div>
            <div class="mobile-card-field" *ngIf="item.locationType">
              <span class="field-label">Type:</span>
              <span class="field-value">{{ item.locationType }}</span>
            </div>
          </div>
        </div>

        <div class="mobile-card-actions">
          <div class="quick-actions">
            <button class="icon-btn action-view" (click)="openViewDialog(item)" title="View Details" aria-label="View Details">
              <i class="fas fa-eye"></i>
            </button>
            <button class="icon-btn action-edit" (click)="openEditDialog(item)" title="Edit" aria-label="Edit">
              <i class="fas fa-edit"></i>
            </button>
            <button class="icon-btn action-toggle" (click)="toggleActiveStatusAndClose(item)" title="Toggle Status"
              aria-label="Toggle Status" [class.inactive]="!item.isActive">
              <i class="fas" [class.fa-toggle-on]="!item.isActive" [class.fa-toggle-off]="item.isActive"></i>
            </button>
            <button class="icon-btn action-delete" (click)="deleteItemAndClose(item)" title="Delete" aria-label="Delete">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  <div class="pagination-section" *ngIf="totalPages > 1" (click)="onMainPageClick($event)">
    <div class="pagination-content">
      <div class="pagination-info">
        <span class="items-per-page">
          <label>Rows per page:</label>
          <div class="searchable-dropdown">
            <div class="dropdown-trigger" (click)="toggleSearchableDropdown('items-per-page'); $event.stopPropagation()">
              <span class="dropdown-value">{{ itemsPerPageFormData }}</span>
              <i class="dropdown-icon"></i>
            </div>
            <div class="dropdown-menu" *ngIf="dropdownStates['items-per-page']?.isOpen">
              <div class="dropdown-options">
                <div *ngFor="let option of dropdownStates['items-per-page']?.filteredOptions"
                  class="dropdown-option" [class.selected]="itemsPerPageFormData === parseInt(option)"
                  (click)="selectItemsPerPageOption(option)">
                  {{ option }}
                  <i *ngIf="itemsPerPageFormData === parseInt(option)" class="fas fa-check selected-icon"></i>
                </div>
              </div>
            </div>
          </div>
        </span>
        <span class="pagination-text">
          Showing {{ (currentPage - 1) * itemsPerPage + 1 }} to
          {{ Math.min(currentPage * itemsPerPage, totalItems) }} of
          {{ totalItems }} entries
        </span>
      </div>

      <div class="pagination-controls">
        <button class="btn btn-outline btn-sm" [disabled]="currentPage === 1" (click)="onPageChange(1)">
          <i class="fas fa-angle-double-left"></i>
        </button>
        <button class="btn btn-outline btn-sm" [disabled]="currentPage === 1" (click)="onPageChange(currentPage - 1)">
          <i class="fas fa-angle-left"></i>
        </button>
        <span class="page-info">Page {{ currentPage }} of {{ totalPages }}</span>
        <button class="btn btn-outline btn-sm" [disabled]="currentPage === totalPages" (click)="onPageChange(currentPage + 1)">
          <i class="fas fa-angle-right"></i>
        </button>
        <button class="btn btn-outline btn-sm" [disabled]="currentPage === totalPages" (click)="onPageChange(totalPages)">
          <i class="fas fa-angle-double-right"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Add/Edit Dialog -->
  <div class="modal-overlay" *ngIf="showAddEditDialog">
    <div class="modal modal-lg">
      <div class="modal-header">
        <div class="header-content">
          <div class="header-icon">
            <i class="fas" [class.fa-plus]="dialogMode === 'add'" [class.fa-edit]="dialogMode === 'edit'"></i>
          </div>
          <div class="header-text">
            <h2>{{ dialogMode === 'add' ? 'Add New Location' : 'Edit Location' }}</h2>
            <p class="modal-subtitle">{{ dialogMode === 'add' ? 'Create a new location' : 'Modify existing location details' }}</p>
          </div>
        </div>
        <button class="btn-close" (click)="closeDialogs()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal-body" (click)="onModalBodyClick($event)">
        <form [formGroup]="locationForm" (ngSubmit)="saveItem()" class="modern-form">
          <div class="form-sections">
            <!-- Basic Information Section -->
            <div class="form-section">
              <div class="section-title-container basic-info">
                <div class="section-icon-wrapper">
                  <i class="fas fa-info-circle"></i>
                </div>
                <div class="section-title-content">
                  <h3 class="section-title">Basic Information</h3>
                </div>
                <div class="section-decoration"></div>
              </div>
              <div class="form-grid">
                <div class="form-group">
                  <label for="name" class="form-label">
                    Location Name <span class="required">*</span>
                  </label>
                  <div class="input-wrapper">
                    <input id="name" type="text" formControlName="name"
                      [class.form-control]="!locationForm.get('name')?.invalid"
                      [class.form-control-error]="locationForm.get('name')?.invalid && locationForm.get('name')?.touched"
                      placeholder="Enter location name" required>
                    <div class="input-status" *ngIf="locationForm.get('name')?.value && !locationForm.get('name')?.invalid">
                      <i class="fas fa-check-circle status-valid"></i>
                    </div>
                  </div>
                  <div class="error-message" *ngIf="locationForm.get('name')?.invalid && locationForm.get('name')?.touched">
                    <span class="error-icon"></span>
                    Location name is required
                  </div>
                </div>

                <div class="form-group">
                  <label for="managerName" class="form-label">Manager Name</label>
                  <div class="input-wrapper">
                    <input id="managerName" type="text" formControlName="managerName"
                      class="form-control" placeholder="Enter manager name">
                  </div>
                </div>

                <div class="form-group">
                  <label for="locationCode" class="form-label">Location Code</label>
                  <div class="input-wrapper">
                    <input id="locationCode" type="text" formControlName="locationCode"
                      class="form-control" placeholder="e.g., MAIN-001">
                  </div>
                </div>

                <div class="form-group">
                  <label for="locationType" class="form-label">
                    Location Type <span class="required">*</span>
                  </label>
                  <div class="searchable-dropdown" (click)="$event.stopPropagation()">
                    <div class="dropdown-trigger" (click)="toggleSearchableDropdown('locationType'); $event.stopPropagation()" (focus)="onFormFieldFocus()">
                      <span class="dropdown-value">
                        {{ locationForm.get('locationType')?.value || 'Select Location Type' }}
                      </span>
                      <i class="dropdown-icon"></i>
                    </div>
                    <div class="dropdown-menu" *ngIf="dropdownStates['locationType']?.isOpen">
                      <div class="dropdown-options">
                        <div *ngFor="let type of locationTypes" 
                          class="dropdown-option" 
                          [class.selected]="locationForm.get('locationType')?.value === type"
                          (click)="locationForm.patchValue({ locationType: type }); closeAllSearchableDropdowns()">
                          {{ type }}
                          <i *ngIf="locationForm.get('locationType')?.value === type" class="fas fa-check selected-icon"></i>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="error-message" *ngIf="locationForm.get('locationType')?.invalid && locationForm.get('locationType')?.touched">
                    <span class="error-icon"></span>
                    Location type is required
                  </div>
                </div>

                <div class="form-group">
                  <label for="parentLocation" class="form-label">Parent Location</label>
                  <div class="searchable-dropdown" (click)="$event.stopPropagation()">
                    <div class="dropdown-trigger" (click)="toggleSearchableDropdown('parentLocation'); $event.stopPropagation()" (focus)="onFormFieldFocus()">
                      <span class="dropdown-value">
                        {{ getParentLocationDisplay() || 'Select Parent Location (Optional)' }}
                      </span>
                      <i 
                        *ngIf="hasDropdownValue('parentLocation')"
                        class="fas fa-times clear-icon"
                        (click)="clearDropdownValue('parentLocation', $event)"
                        title="Clear selection"
                      ></i>
                      <i class="dropdown-icon"></i>
                    </div>
                    <div class="dropdown-menu" *ngIf="dropdownStates['parentLocation']?.isOpen">
                      <div class="search-input-container">
                        <input type="text" class="search-input" placeholder="Search locations..."
                          [value]="dropdownStates['parentLocation'].searchTerm" (input)="onSearchInput('parentLocation', $event)">
                        <i class="search-icon"></i>
                      </div>
                      <div class="dropdown-options">
                        <div class="dropdown-option" [class.selected]="!locationForm.get('parentLocationId')?.value" (click)="locationForm.patchValue({ parentLocationId: null }); closeAllSearchableDropdowns()">
                          None
                          <i *ngIf="!locationForm.get('parentLocationId')?.value" class="fas fa-check selected-icon"></i>
                        </div>
                        <div *ngFor="let parent of (dropdownStates['parentLocation']?.filteredLocations || parentLocations)" 
                          class="dropdown-option" 
                          [class.selected]="locationForm.get('parentLocationId')?.value === parent.id"
                          (click)="locationForm.patchValue({ parentLocationId: parent.id }); closeAllSearchableDropdowns()">
                          {{ parent.name }}
                          <i *ngIf="locationForm.get('parentLocationId')?.value === parent.id" class="fas fa-check selected-icon"></i>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Address Information Section -->
            <div class="form-section">
              <div class="section-title-container basic-info">
                <div class="section-icon-wrapper">
                  <i class="fas fa-map-marker-alt"></i>
                </div>
                <div class="section-title-content">
                  <h3 class="section-title">Address Information</h3>
                </div>
                <div class="section-decoration"></div>
              </div>
              <div class="form-grid">
                <div class="form-group form-group-full">
                  <label for="address" class="form-label">Address</label>
                  <div class="input-wrapper">
                    <input id="address" type="text" formControlName="address"
                      class="form-control" placeholder="Enter street address">
                  </div>
                </div>

                <div class="form-group">
                  <label for="city" class="form-label">City</label>
                  <div class="input-wrapper">
                    <input id="city" type="text" formControlName="city"
                      class="form-control" placeholder="Enter city">
                  </div>
                </div>

                <div class="form-group">
                  <label for="state" class="form-label">State/Province</label>
                  <div class="input-wrapper">
                    <input id="state" type="text" formControlName="state"
                      class="form-control" placeholder="Enter state or province">
                  </div>
                </div>

                <div class="form-group">
                  <label for="country" class="form-label">Country</label>
                  <div class="input-wrapper">
                    <input id="country" type="text" formControlName="country"
                      class="form-control" placeholder="Enter country">
                  </div>
                </div>

                <div class="form-group">
                  <label for="postalCode" class="form-label">Postal Code</label>
                  <div class="input-wrapper">
                    <input id="postalCode" type="text" formControlName="postalCode"
                      class="form-control" placeholder="Enter postal code">
                  </div>
                </div>
              </div>
            </div>

            <!-- Contact Information Section -->
            <div class="form-section">
              <div class="section-title-container basic-info">
                <div class="section-icon-wrapper">
                  <i class="fas fa-phone"></i>
                </div>
                <div class="section-title-content">
                  <h3 class="section-title">Contact Information</h3>
                </div>
                <div class="section-decoration"></div>
              </div>
              <div class="form-grid">
                <div class="form-group">
                  <label for="phone" class="form-label">
                    Phone <span class="required">*</span>
                  </label>
                  <div class="input-wrapper">
                    <input id="phone" type="tel" formControlName="phone"
                      [class.form-control]="!locationForm.get('phone')?.invalid"
                      [class.form-control-error]="locationForm.get('phone')?.invalid && locationForm.get('phone')?.touched"
                      placeholder="+1 (555) 123-4567" required>
                    <div class="input-status" *ngIf="locationForm.get('phone')?.value && !locationForm.get('phone')?.invalid">
                      <i class="fas fa-check-circle status-valid"></i>
                    </div>
                  </div>
                  <div class="error-message" *ngIf="locationForm.get('phone')?.invalid && locationForm.get('phone')?.touched">
                    <span class="error-icon"></span>
                    Phone is required
                  </div>
                </div>

                <div class="form-group">
                  <label for="email" class="form-label">
                    Email <span class="required">*</span>
                  </label>
                  <div class="input-wrapper">
                    <input id="email" type="email" formControlName="email"
                      [class.form-control]="!locationForm.get('email')?.invalid"
                      [class.form-control-error]="locationForm.get('email')?.invalid && locationForm.get('email')?.touched"
                      placeholder="location@example.com" required>
                    <div class="input-status" *ngIf="locationForm.get('email')?.value && !locationForm.get('email')?.invalid">
                      <i class="fas fa-check-circle status-valid"></i>
                    </div>
                  </div>
                  <div class="error-message" *ngIf="locationForm.get('email')?.invalid && locationForm.get('email')?.touched">
                    <span class="error-icon"></span>
                    <span *ngIf="locationForm.get('email')?.errors?.['required']">Email is required</span>
                    <span *ngIf="!locationForm.get('email')?.errors?.['required'] && locationForm.get('email')?.errors?.['email']">Please enter a valid email address</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Location Settings Section -->
            <div class="form-section">
              <div class="section-title-container basic-info">
                <div class="section-icon-wrapper">
                  <i class="fas fa-cog"></i>
                </div>
                <div class="section-title-content">
                  <h3 class="section-title">Location Settings</h3>
                </div>
                <div class="section-decoration"></div>
              </div>
              <div class="form-grid">
                <div class="form-group">
                  <label for="timezone" class="form-label">Time Zone</label>
                  <div class="input-wrapper">
                    <input id="timezone" type="text" formControlName="timezone"
                      class="form-control" placeholder="e.g., UTC, America/New_York">
                  </div>
                </div>

                <div class="form-group">
                  <label for="currency" class="form-label">Currency</label>
                  <div class="searchable-dropdown" (click)="$event.stopPropagation()">
                    <div class="dropdown-trigger" (click)="toggleSearchableDropdown('currency'); $event.stopPropagation()" (focus)="onFormFieldFocus()">
                      <span class="dropdown-value">
                        {{ getDisplayValue('currency') || 'Select Currency' }}
                      </span>
                      <i 
                        *ngIf="hasDropdownValue('currency')"
                        class="fas fa-times clear-icon"
                        (click)="clearDropdownValue('currency', $event)"
                        title="Clear selection"
                      ></i>
                      <i class="dropdown-icon"></i>
                    </div>
                    <div class="dropdown-menu" *ngIf="dropdownStates['currency']?.isOpen">
                      <div class="search-input-container">
                        <input type="text" class="search-input" placeholder="Search currencies..."
                          [value]="dropdownStates['currency'].searchTerm" (input)="onSearchInput('currency', $event)">
                        <i class="search-icon"></i>
                      </div>
                      <div class="dropdown-options">
                        <div class="dropdown-option" [class.selected]="!locationForm.get('currency')?.value" (click)="selectOption('currency', '')">
                          None
                          <i *ngIf="!locationForm.get('currency')?.value" class="fas fa-check selected-icon"></i>
                        </div>
                        <div *ngFor="let currency of (dropdownStates['currency']?.filteredCurrencies || currencies)" 
                          class="dropdown-option" 
                          [class.selected]="locationForm.get('currency')?.value === currency.code"
                          (click)="locationForm.patchValue({ currency: currency.code }); closeAllSearchableDropdowns()">
                          {{ currency.code }} - {{ currency.name }}
                          <i *ngIf="locationForm.get('currency')?.value === currency.code" class="fas fa-check selected-icon"></i>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="form-group">
                  <label for="language" class="form-label">Language</label>
                  <div class="input-wrapper">
                    <input id="language" type="text" formControlName="language"
                      class="form-control" placeholder="e.g., en, es, fr">
                  </div>
                </div>
              </div>
            </div>

            <!-- Location Coordinates Section -->
            <div class="form-section">
              <div class="section-title-container basic-info">
                <div class="section-icon-wrapper">
                  <i class="fas fa-globe"></i>
                </div>
                <div class="section-title-content">
                  <h3 class="section-title">Location Coordinates</h3>
                </div>
                <div class="section-decoration"></div>
              </div>
              <div class="form-grid">
                <div class="form-group">
                  <label for="latitude" class="form-label">Latitude</label>
                  <div class="input-wrapper">
                    <input id="latitude" type="number" step="0.000001" formControlName="latitude"
                      class="form-control" placeholder="e.g., 40.7128">
                  </div>
                </div>

                <div class="form-group">
                  <label for="longitude" class="form-label">Longitude</label>
                  <div class="input-wrapper">
                    <input id="longitude" type="number" step="0.000001" formControlName="longitude"
                      class="form-control" placeholder="e.g., -74.0060">
                  </div>
                </div>
              </div>
            </div>

            <!-- Status Section -->
            <div class="form-section">
              <div class="section-title-container basic-info">
                <div class="section-icon-wrapper">
                  <i class="fas fa-shield-alt"></i>
                </div>
                <div class="section-title-content">
                  <h3 class="section-title">Status</h3>
                </div>
                <div class="section-decoration"></div>
              </div>
              <div class="form-grid">
                <div class="form-group">
                  <label for="isActive" class="form-label">Active Status</label>
                  <div class="simple-status-toggle">
                    <label class="toggle-switch">
                      <input id="isActive" type="checkbox" formControlName="isActive">
                      <span class="toggle-slider"></span>
                    </label>
                    <span class="status-text" [class.active]="locationForm.get('isActive')?.value" [class.inactive]="!locationForm.get('isActive')?.value">
                      {{ locationForm.get('isActive')?.value ? 'Active' : 'Inactive' }}
                    </span>
                  </div>
                </div>
                <div class="form-group">
                  <label for="isDefault" class="form-label">Default Location</label>
                  <div class="simple-status-toggle">
                    <label class="toggle-switch">
                      <input id="isDefault" type="checkbox" formControlName="isDefault">
                      <span class="toggle-slider"></span>
                    </label>
                    <span class="status-text" [class.active]="locationForm.get('isDefault')?.value" [class.inactive]="!locationForm.get('isDefault')?.value">
                      {{ locationForm.get('isDefault')?.value ? 'Yes' : 'No' }}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn btn-outline" (click)="closeDialogs()">
              <i class="fas fa-times"></i>
              Cancel
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="isSubmitting || locationForm.invalid">
              <i class="fas" [class.fa-plus]="dialogMode === 'add' && !isSubmitting"
                [class.fa-save]="dialogMode === 'edit' && !isSubmitting" [class.fa-spinner]="isSubmitting"
                [class.fa-spin]="isSubmitting"></i>
              {{ isSubmitting ? 'Saving...' : (dialogMode === 'add' ? 'Create Location' : 'Save Changes') }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- View Dialog -->
  <div class="modal-overlay" *ngIf="showViewDialog">
    <div class="modal modal-lg">
      <div class="modal-header">
        <div class="header-content">
          <div class="header-icon">
            <i class="fas fa-map-marker-alt"></i>
          </div>
          <div class="header-text">
            <h2>Location Details</h2>
            <p class="modal-subtitle" *ngIf="selectedItem">{{ selectedItem.name }}</p>
          </div>
        </div>
        <div class="header-actions">
          <button class="btn btn-outline btn-sm" (click)="exportLocationDetailsAsPDF()" title="Export as PDF">
            <i class="fas fa-file-pdf"></i>
            Export PDF
          </button>
          <button class="btn-close" (click)="closeDialogs()">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>

      <div class="modal-body" *ngIf="selectedItem">
        <div class="profile-form">
          <!-- Basic Information Section -->
          <div class="info-card">
            <div class="card-header">
              <div class="card-header-content">
                <div class="card-icon personal">
                  <i class="fas fa-info-circle"></i>
                </div>
                <div>
                  <h2 class="card-title">Basic Information</h2>
                  <p class="card-subtitle">Location name, manager, code, and contact details</p>
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="form-row">
                <div class="form-field">
                  <label class="field-label">Name</label>
                  <div class="field-value">{{ selectedItem.name }}</div>
                </div>
                <div class="form-field">
                  <label class="field-label">Status</label>
                  <div class="field-value">
                    <span class="status-badge" [class]="getStatusClass(selectedItem.isActive)">
                      {{ selectedItem.isActive ? 'Active' : 'Inactive' }}
                    </span>
                  </div>
                </div>
              </div>
              <div class="form-row">
                <div class="form-field">
                  <label class="field-label">Location Code</label>
                  <div class="field-value">{{ selectedItem.locationCode || '-' }}</div>
                </div>
                <div class="form-field">
                  <label class="field-label">Manager Name</label>
                  <div class="field-value">{{ selectedItem.managerName || '-' }}</div>
                </div>
              </div>
              <div class="form-row">
                <div class="form-field">
                  <label class="field-label">Phone</label>
                  <div class="field-value">{{ selectedItem.phone || '-' }}</div>
                </div>
                <div class="form-field">
                  <label class="field-label">Email</label>
                  <div class="field-value">{{ selectedItem.email || '-' }}</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Address Information Section -->
          <div class="info-card">
            <div class="card-header">
              <div class="card-header-content">
                <div class="card-icon work">
                  <i class="fas fa-map-marker-alt"></i>
                </div>
                <div>
                  <h2 class="card-title">Address Information</h2>
                  <p class="card-subtitle">Location address and geographical details</p>
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="form-row">
                <div class="form-field full-width">
                  <label class="field-label">Address</label>
                  <div class="field-value">{{ selectedItem.address || '-' }}</div>
                </div>
              </div>
              <div class="form-row">
                <div class="form-field">
                  <label class="field-label">City</label>
                  <div class="field-value">{{ selectedItem.city || '-' }}</div>
                </div>
                <div class="form-field">
                  <label class="field-label">State</label>
                  <div class="field-value">{{ selectedItem.state || '-' }}</div>
                </div>
              </div>
              <div class="form-row">
                <div class="form-field">
                  <label class="field-label">Country</label>
                  <div class="field-value">{{ selectedItem.country || '-' }}</div>
                </div>
                <div class="form-field">
                  <label class="field-label">Postal Code</label>
                  <div class="field-value">{{ selectedItem.postalCode || '-' }}</div>
                </div>
              </div>
              <div class="form-row" *ngIf="selectedItem.latitude || selectedItem.longitude">
                <div class="form-field">
                  <label class="field-label">Latitude</label>
                  <div class="field-value">{{ selectedItem.latitude || '-' }}</div>
                </div>
                <div class="form-field">
                  <label class="field-label">Longitude</label>
                  <div class="field-value">{{ selectedItem.longitude || '-' }}</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Location Configuration Section -->
          <div class="info-card">
            <div class="card-header">
              <div class="card-header-content">
                <div class="card-icon notes">
                  <i class="fas fa-cog"></i>
                </div>
                <div>
                  <h2 class="card-title">Location Configuration</h2>
                  <p class="card-subtitle">Location type, hierarchy, timezone, and regional settings</p>
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="form-row">
                <div class="form-field">
                  <label class="field-label">Location Type</label>
                  <div class="field-value">{{ selectedItem.locationType || '-' }}</div>
                </div>
                <div class="form-field">
                  <label class="field-label">Default Location</label>
                  <div class="field-value">
                    <span class="status-badge" [class.status-active]="selectedItem.isDefault" [class.status-inactive]="!selectedItem.isDefault">
                      {{ selectedItem.isDefault ? 'Yes' : 'No' }}
                    </span>
                  </div>
                </div>
              </div>
              <div class="form-row">
                <div class="form-field">
                  <label class="field-label">Parent Location</label>
                  <div class="field-value">{{ getParentLocationName(selectedItem.parentLocationId) || 'Root' }}</div>
                </div>
                <div class="form-field">
                  <label class="field-label">Level</label>
                  <div class="field-value">{{ selectedItem.level !== undefined ? selectedItem.level : '-' }}</div>
                </div>
              </div>
              <div class="form-row">
                <div class="form-field">
                  <label class="field-label">Time Zone</label>
                  <div class="field-value">{{ selectedItem.timezone || '-' }}</div>
                </div>
                <div class="form-field">
                  <label class="field-label">Currency</label>
                  <div class="field-value">{{ selectedItem.currency || '-' }}</div>
                </div>
              </div>
              <div class="form-row">
                <div class="form-field">
                  <label class="field-label">Language</label>
                  <div class="field-value">{{ selectedItem.language || '-' }}</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Dates & Metadata Section -->
          <div class="info-card">
            <div class="card-header">
              <div class="card-header-content">
                <div class="card-icon work">
                  <i class="fas fa-calendar"></i>
                </div>
                <div>
                  <h2 class="card-title">Dates & Metadata</h2>
                  <p class="card-subtitle">Creation, modification, and tracking information</p>
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="form-row">
                <div class="form-field">
                  <label class="field-label">Created Date</label>
                  <div class="field-value">{{ selectedItem.createdAtUtc ? formatDateTime(selectedItem.createdAtUtc) : (selectedItem.createdAt ? formatDate(selectedItem.createdAt) : '-') }}</div>
                </div>
                <div class="form-field">
                  <label class="field-label">Created By</label>
                  <div class="field-value">{{ selectedItem.createdByName || selectedItem.createdBy || '-' }}</div>
                </div>
              </div>
              <div class="form-row">
                <div class="form-field">
                  <label class="field-label">Modified Date</label>
                  <div class="field-value">{{ selectedItem.modifiedAtUtc ? formatDateTime(selectedItem.modifiedAtUtc) : (selectedItem.updatedAt ? formatDate(selectedItem.updatedAt) : '-') }}</div>
                </div>
                <div class="form-field">
                  <label class="field-label">Modified By</label>
                  <div class="field-value">{{ selectedItem.modifiedByName || selectedItem.modifiedBy || '-' }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn btn-outline" (click)="closeDialogs()">
            Close
          </button>
          <button class="btn btn-primary" (click)="openEditDialogFromView(selectedItem!)">
            <i class="fas fa-edit"></i>
            Edit Location
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Dialog -->
  <div class="modal-overlay" *ngIf="showDeleteDialog">
    <div class="modal modal-sm modal-danger">
      <div class="modal-header">
        <div class="header-content">
          <div class="header-icon">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
          <div class="header-text">
            <h2>Delete Location</h2>
            <p class="modal-subtitle">This action cannot be undone</p>
          </div>
        </div>
        <button class="btn-close" (click)="closeDialogs()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <div class="warning-content">
          <div class="warning-icon">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
          <div class="warning-text">
            <p>
              This action cannot be undone. This will permanently delete
              <span class="item-count">
                {{ deleteItemCount }} {{ deleteItemCount === 1 ? 'location' : 'locations' }}
              </span>
              from the system.
            </p>
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn btn-outline" (click)="closeDialogs()">
            <i class="fas fa-times"></i>
            Cancel
          </button>
          <button class="btn btn-danger" (click)="confirmDelete()">
            <i class="fas fa-trash"></i>
            Delete {{ deleteItemCount === 1 ? 'Location' : 'Locations' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Import Dialog -->
  <div class="modal-overlay" *ngIf="showImportDialog">
    <div class="modal modal-lg">
      <div class="modal-header">
        <div class="header-content">
          <div class="header-icon">
            <i class="fas fa-file-import"></i>
          </div>
          <div class="header-text">
            <h2>Import Locations</h2>
            <p class="modal-subtitle">Upload CSV or Excel file to import locations</p>
          </div>
        </div>
        <button class="btn-close" (click)="closeImportDialog()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <div class="import-container">
          <div class="import-section">
            <div class="section-header">
              <i class="fas fa-download"></i>
              <h3>Step 1: Download Template</h3>
            </div>
            <p class="section-description">Download the Excel template with all required columns.</p>
            <button class="btn btn-outline" type="button" (click)="downloadTemplate()">
              <i class="fas fa-file-download"></i>
              <span>Download Template</span>
            </button>
          </div>

          <div class="import-section">
            <div class="section-header">
              <i class="fas fa-upload"></i>
              <h3>Step 2: Upload File</h3>
            </div>
            <p class="section-description">Select a CSV or Excel file. Maximum size: 5MB</p>
            <div class="file-upload-area" [class.has-file]="selectedFile" (dragover)="onDragOver($event)"
              (dragenter)="onDragEnter($event)" (dragleave)="onDragLeave($event)" (drop)="onDrop($event)">
              <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" (change)="onFileSelected($event)" style="display: none;">
              <div *ngIf="!selectedFile" class="upload-placeholder" (click)="triggerFileInput()">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>Click to browse or drag and drop</p>
                <span>Supported: CSV, Excel (.xlsx, .xls)</span>
              </div>
              <div *ngIf="selectedFile" class="file-selected">
                <div class="file-info">
                  <i class="fas fa-file-excel"></i>
                  <div class="file-details">
                    <span class="file-name">{{ selectedFile.name }}</span>
                    <span class="file-size">{{ (selectedFile.size / 1024).toFixed(2) }} KB</span>
                  </div>
                </div>
                <div class="file-actions">
                  <button class="btn-browse" type="button" (click)="triggerFileInput()" title="Browse for another file">
                    <i class="fas fa-folder-open"></i>
                  </button>
                  <button class="btn-remove" type="button" (click)="removeSelectedFile()" title="Remove file">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="import-section" *ngIf="importErrors.length > 0">
            <div class="section-header">
              <i class="fas fa-exclamation-triangle"></i>
              <h3>Import Errors ({{ importErrors.length }})</h3>
            </div>
            <div class="import-errors">
              <div class="error-list">
                <div class="error-item" *ngFor="let error of importErrors">
                  <i class="fas fa-times-circle"></i>
                  <span>{{ error }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Import Instructions -->
          <div class="import-section">
            <div class="section-header">
              <i class="fas fa-info-circle"></i>
              <h3>Import Instructions</h3>
            </div>
            <p class="section-description">Follow these guidelines to ensure successful import of your location data.</p>

            <div class="import-instructions">
              <ul>
                <li><strong>Required Fields:</strong> Name, Phone, Email, and Location Type are mandatory</li>
                <li><strong>Email:</strong> Must be a valid email format</li>
                <li><strong>Location Type:</strong> Must be one of: HEADQUARTERS, BRANCH, WAREHOUSE, RETAIL, OFFICE, DISTRIBUTION_CENTER</li>
                <li><strong>Parent Location:</strong> Optional - enter the exact name of an existing location</li>
                <li><strong>Status:</strong> Must be "Active" or "Inactive" (case-insensitive)</li>
                <li><strong>Currency:</strong> Select from the dropdown of active currencies</li>
                <li><strong>Duplicates:</strong> Rows with existing location names will be automatically skipped</li>
                <li><strong>Template:</strong> Download the template above to see the correct format and sample data</li>
              </ul>
            </div>
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn btn-outline" type="button" (click)="closeImportDialog()" [disabled]="isImporting">
            <i class="fas fa-times"></i>
            Cancel
          </button>
          <button class="btn btn-primary" type="button" (click)="importData()" [disabled]="!selectedFile || isImporting">
            <i class="fas" [class.fa-file-import]="!isImporting" [class.fa-spinner]="isImporting" [class.fa-spin]="isImporting"></i>
            {{ isImporting ? 'Importing...' : 'Import Data' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Import History Dialog -->
  <div class="modal-overlay" *ngIf="showImportHistoryDialog">
    <div class="modal modal-lg">
      <div class="modal-header">
        <div class="header-content">
          <div class="header-icon">
            <i class="fas fa-history"></i>
          </div>
          <div class="header-text">
            <h2>Import/Export History</h2>
            <p class="modal-subtitle">View all location import and export operations</p>
          </div>
        </div>
        <button class="btn-close" (click)="closeImportHistoryDialog()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <div class="import-history-container">
          <div class="history-filters">
            <button class="filter-btn" [class.active]="historyType === undefined" (click)="filterHistory('all')">
              All
            </button>
            <button class="filter-btn" [class.active]="historyType === 'import'" (click)="filterHistory('import')">
              <i class="fas fa-upload"></i> Import
            </button>
            <button class="filter-btn" [class.active]="historyType === 'export'" (click)="filterHistory('export')">
              <i class="fas fa-download"></i> Export
            </button>
          </div>

          <div *ngIf="isLoadingHistory" class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <span>Loading history...</span>
          </div>

          <div *ngIf="!isLoadingHistory && history.length === 0" class="empty-state">
            <i class="fas fa-history"></i>
            <h3>No history found</h3>
            <p>History will appear here after you import or export locations</p>
          </div>

          <!-- History Table (Desktop) -->
          <div *ngIf="!isLoadingHistory && history.length > 0 && !isMobile" class="history-table-wrapper">
            <table class="history-table">
              <thead>
                <tr>
                  <th>Type</th>
                  <th>File Name</th>
                  <th>Format</th>
                  <th>Date</th>
                  <th>Progress</th>
                  <th>Status</th>
                  <th class="text-center">Total Rows</th>
                  <th class="text-center">Success</th>
                  <th class="text-center">Updated</th>
                  <th class="text-center">Skipped</th>
                  <th class="text-center">Errors</th>
                  <th>Strategy</th>
                  <th>File Size</th>
                  <th>User</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let h of history">
                  <!-- Type Column -->
                  <td>
                    <span class="operation-badge" [class.import]="h.operationType === 'Import'" [class.export]="h.operationType === 'Export'">
                      <i class="fas" [class.fa-upload]="h.operationType === 'Import'" [class.fa-download]="h.operationType === 'Export'"></i>
                      {{ h.operationType }}
                    </span>
                  </td>

                  <!-- File Name -->
                  <td class="file-name">
                    <i class="fas fa-file-excel"></i>
                    {{ h.fileName }}
                  </td>

                  <!-- Format -->
                  <td>
                    <span class="format-badge">{{ h.format }}</span>
                  </td>

                  <!-- Date -->
                  <td>{{ formatDateTime(h.createdAtUtc) }}</td>

                  <!-- Progress -->
                  <td class="progress-column">
                    <div *ngIf="isCurrentJob(h)" class="mini-progress">
                      <div class="mini-progress-bar">
                        <div class="mini-progress-fill" [style.width.%]="h.progress"></div>
                      </div>
                      <span class="mini-progress-text">{{ h.progress }}%</span>
                    </div>
                    <div *ngIf="!isCurrentJob(h) && (h.status === 'Processing' || h.status === 'Pending')" class="mini-progress">
                      <div class="mini-progress-bar">
                        <div class="mini-progress-fill" [style.width.%]="h.progress"></div>
                      </div>
                      <span class="mini-progress-text">{{ h.progress }}%</span>
                    </div>
                    <span *ngIf="!isCurrentJob(h) && h.status !== 'Processing' && h.status !== 'Pending'">{{ h.progress }}%</span>
                  </td>

                  <!-- Status -->
                  <td>
                    <span [ngClass]="getHistoryStatusClass(h.status)">
                      {{ h.status }}
                    </span>
                  </td>

                  <!-- Total Rows -->
                  <td class="text-center">{{ h.totalRows }}</td>

                  <!-- Success -->
                  <td class="text-center">
                    <span class="badge badge-success" *ngIf="h.successCount > 0">
                      {{ h.successCount }}
                    </span>
                    <span *ngIf="h.successCount === 0">-</span>
                  </td>

                  <!-- Updated -->
                  <td class="text-center">
                    <span class="badge badge-info" *ngIf="h.updatedCount > 0">
                      {{ h.updatedCount }}
                    </span>
                    <span *ngIf="h.updatedCount === 0">-</span>
                  </td>

                  <!-- Skipped -->
                  <td class="text-center">
                    <span class="badge badge-warning" *ngIf="h.skippedCount > 0">
                      {{ h.skippedCount }}
                    </span>
                    <span *ngIf="h.skippedCount === 0">-</span>
                  </td>

                  <!-- Errors -->
                  <td class="text-center">
                    <div *ngIf="h.errorCount > 0">
                      <span class="badge badge-danger">{{ h.errorCount }}</span>
                    </div>
                    <span *ngIf="h.errorCount === 0">-</span>
                  </td>

                  <!-- Strategy -->
                  <td>
                    <span class="strategy-badge" *ngIf="h.duplicateHandlingStrategy">
                      {{ getStrategyDisplayName(h.duplicateHandlingStrategy) }}
                    </span>
                    <span *ngIf="!h.duplicateHandlingStrategy">-</span>
                  </td>

                  <!-- File Size -->
                  <td>{{ formatFileSize(h.fileSizeBytes) }}</td>

                  <!-- User -->
                  <td>{{ h.importedBy }}</td>

                  <!-- Actions -->
                  <td>
                    <!-- For Imports: Download Error Report -->
                    <button *ngIf="h.operationType === 'Import' && h.errorReportId"
                            class="btn-download-error-report btn-sm"
                            (click)="downloadErrorReportForHistory(h.id)"
                            title="Download Error Report">
                      <i class="fas fa-file-csv"></i>
                    </button>

                    <!-- For Exports: Download File -->
                    <button *ngIf="h.operationType === 'Export' && h.status === 'Completed'"
                            class="btn-download-error-report btn-sm"
                            (click)="downloadExportFromHistory(h.id)"
                            title="Download Export">
                      <i class="fas fa-download"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- History Mobile Cards -->
          <div *ngIf="!isLoadingHistory && history.length > 0 && isMobile" class="mobile-cards">
            <div *ngFor="let h of history" class="mobile-card">
              <div class="mobile-card-header">
                <div class="mobile-card-title">
                  <span class="operation-badge" [class.import]="h.operationType === 'Import'" [class.export]="h.operationType === 'Export'">
                    <i class="fas" [class.fa-upload]="h.operationType === 'Import'" [class.fa-download]="h.operationType === 'Export'"></i>
                    {{ h.operationType }}
                  </span>
                  <span [ngClass]="getHistoryStatusClass(h.status)" class="status-badge-mobile">
                    {{ h.status }}
                  </span>
                </div>
              </div>
              <div class="mobile-card-body">
                <div class="mobile-card-grid">
                  <div class="mobile-card-field">
                    <span class="field-label">File Name</span>
                    <span class="field-value">
                      <i class="fas fa-file-excel"></i>
                      {{ h.fileName }}
                    </span>
                  </div>
                  <div class="mobile-card-field">
                    <span class="field-label">Format</span>
                    <span class="field-value">
                      <span class="format-badge">{{ h.format }}</span>
                    </span>
                  </div>
                  <div class="mobile-card-field">
                    <span class="field-label">Date</span>
                    <span class="field-value">{{ formatDateTime(h.createdAtUtc) }}</span>
                  </div>
                  <div class="mobile-card-field">
                    <span class="field-label">Progress</span>
                    <span class="field-value">
                      <div *ngIf="isCurrentJob(h) || (h.status === 'Processing' || h.status === 'Pending')" class="mini-progress">
                        <div class="mini-progress-bar">
                          <div class="mini-progress-fill" [style.width.%]="h.progress"></div>
                        </div>
                        <span class="mini-progress-text">{{ h.progress }}%</span>
                      </div>
                      <span *ngIf="!isCurrentJob(h) && h.status !== 'Processing' && h.status !== 'Pending'">{{ h.progress }}%</span>
                    </span>
                  </div>
                  <div class="mobile-card-field">
                    <span class="field-label">Total Rows</span>
                    <span class="field-value">{{ h.totalRows }}</span>
                  </div>
                  <div class="mobile-card-field">
                    <span class="field-label">Success</span>
                    <span class="field-value">
                      <span class="badge badge-success" *ngIf="h.successCount > 0">{{ h.successCount }}</span>
                      <span *ngIf="h.successCount === 0">-</span>
                    </span>
                  </div>
                  <div class="mobile-card-field">
                    <span class="field-label">Updated</span>
                    <span class="field-value">
                      <span class="badge badge-info" *ngIf="h.updatedCount > 0">{{ h.updatedCount }}</span>
                      <span *ngIf="h.updatedCount === 0">-</span>
                    </span>
                  </div>
                  <div class="mobile-card-field">
                    <span class="field-label">Skipped</span>
                    <span class="field-value">
                      <span class="badge badge-warning" *ngIf="h.skippedCount > 0">{{ h.skippedCount }}</span>
                      <span *ngIf="h.skippedCount === 0">-</span>
                    </span>
                  </div>
                  <div class="mobile-card-field">
                    <span class="field-label">Errors</span>
                    <span class="field-value">
                      <span class="badge badge-danger" *ngIf="h.errorCount > 0">{{ h.errorCount }}</span>
                      <span *ngIf="h.errorCount === 0">-</span>
                    </span>
                  </div>
                  <div class="mobile-card-field" *ngIf="h.duplicateHandlingStrategy">
                    <span class="field-label">Strategy</span>
                    <span class="field-value">
                      <span class="strategy-badge">{{ getStrategyDisplayName(h.duplicateHandlingStrategy) }}</span>
                    </span>
                  </div>
                  <div class="mobile-card-field">
                    <span class="field-label">File Size</span>
                    <span class="field-value">{{ formatFileSize(h.fileSizeBytes) }}</span>
                  </div>
                  <div class="mobile-card-field">
                    <span class="field-label">User</span>
                    <span class="field-value">{{ h.importedBy }}</span>
                  </div>
                </div>
              </div>
              <div class="mobile-card-actions" *ngIf="(h.operationType === 'Import' && h.errorReportId) || (h.operationType === 'Export' && h.status === 'Completed')">
                <div class="quick-actions">
                  <button *ngIf="h.operationType === 'Import' && h.errorReportId"
                          class="icon-btn action-download"
                          (click)="downloadErrorReportForHistory(h.id)"
                          title="Download Error Report">
                    <i class="fas fa-file-csv"></i>
                  </button>
                  <button *ngIf="h.operationType === 'Export' && h.status === 'Completed'"
                          class="icon-btn action-download"
                          (click)="downloadExportFromHistory(h.id)"
                          title="Download Export">
                    <i class="fas fa-download"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Pagination -->
          <div *ngIf="!isLoadingHistory && historyTotalCount > historyPageSize" class="history-pagination">
            <div class="pagination-info">
              <span>
                Showing {{ (historyPage - 1) * historyPageSize + 1 }} to
                {{ Math.min(historyPage * historyPageSize, historyTotalCount) }} of
                {{ historyTotalCount }} entries
              </span>
            </div>
            <div class="pagination-controls">
              <button class="btn btn-outline btn-sm" [disabled]="historyPage === 1" (click)="goToHistoryPage(1)">
                <i class="fas fa-angle-double-left"></i>
              </button>
              <button class="btn btn-outline btn-sm" [disabled]="historyPage === 1" (click)="goToHistoryPage(historyPage - 1)">
                <i class="fas fa-angle-left"></i>
              </button>
              <span class="page-info">
                Page {{ historyPage }} of {{ getHistoryTotalPages() }}
              </span>
              <button class="btn btn-outline btn-sm" [disabled]="historyPage === getHistoryTotalPages()"
                (click)="goToHistoryPage(historyPage + 1)">
                <i class="fas fa-angle-right"></i>
              </button>
              <button class="btn btn-outline btn-sm" [disabled]="historyPage === getHistoryTotalPages()"
                (click)="goToHistoryPage(getHistoryTotalPages())">
                <i class="fas fa-angle-double-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn btn-outline" (click)="closeImportHistoryDialog()">
          <i class="fas fa-times"></i>
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Export Progress Dialog -->
  <div class="modal-overlay" *ngIf="showExportDialog">
    <div class="modal modal-md">
      <div class="modal-header">
        <div class="header-content">
          <div class="header-icon">
            <i class="fas fa-download"></i>
          </div>
          <div class="header-text">
            <h2>Export Progress</h2>
            <p class="modal-subtitle">Your export is being processed</p>
          </div>
        </div>
        <button class="btn-close" (click)="showExportDialog = false">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <div class="export-progress-container">
          <div class="status-icon" [ngSwitch]="exportStatus">
            <i *ngSwitchCase="'Pending'" class="fas fa-clock fa-3x text-warning"></i>
            <i *ngSwitchCase="'Processing'" class="fas fa-spinner fa-spin fa-3x text-primary"></i>
            <i *ngSwitchCase="'Completed'" class="fas fa-check-circle fa-3x text-success"></i>
            <i *ngSwitchCase="'Failed'" class="fas fa-times-circle fa-3x text-danger"></i>
          </div>
          <h3>{{ exportStatus || 'Pending' }}</h3>
          <div class="progress-container" *ngIf="exportStatus === 'Processing' || exportStatus === 'Pending'">
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="exportProgress"></div>
            </div>
            <p class="progress-text">{{ exportProgress }}%</p>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn btn-outline" (click)="showExportDialog = false">
          {{ exportStatus === 'Completed' || exportStatus === 'Failed' ? 'Close' : 'Run in Background' }}
        </button>
      </div>
    </div>
  </div>
</div>
